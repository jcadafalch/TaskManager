@using GestorTareas.Client.Models;
@using GestorTareas.Shared;
@using Microsoft.AspNetCore.Components;
@using MudBlazor;
@using System.Net.Http.Json;
<MudDialog>
    <DialogContent>
        @if(Action == "Modify"){
            <MudTextField @bind-Value="@Contenido" Label="Contenido" Variant="Variant.Filled" />
        }
        @if(Action == "Delete"){
            <MudText>Esta acción <b><i>NO</i></b> se puede deshacer!</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        @if(Action == "Modify"){
            <MudButton OnClick="Submit" Variant="Variant.Filled" Color="Color.Warning">Guardar Cambios</MudButton>
        }
        @if(Action == "Delete"){
            <MudButton OnClick="Submit" Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Eliminar!</MudButton>
        }
    </DialogActions>
</MudDialog>

@code{
    [Inject] protected TareasHttpClient Http { get; set; } = default!;
    [Inject] protected ISnackbar Snackbar { get; set; }
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public TareaDTO Tarea { get; set; }
    [Parameter] public string Contenido { get; set;}
    [Parameter] public string Action { get; set; }

    protected async Task Submit()
    {
        if(Action == "Modify")
        {
            var updatetareadto = new UpdateTareaRequestDTO(Tarea.Id, Contenido);
            var response = await Http.GetUpdateTareaAsync(updatetareadto);

            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add("Ha habido un error en modificar la tarea", Severity.Error);
                return;
            }

            Snackbar.Add("La Tarea " + Tarea.Title + " se ha modificado correctamente", Severity.Success);
        }

        if(Action == "Delete")
        {
            var deletetareadto = new IdRequestDTO(Tarea.Id);
            var response = await Http.GetDeleteTareaAsync(deletetareadto);

            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add("Ha habido un error en eliminar la tarea", Severity.Error);
                return;
            }

            Snackbar.Add("La tarea " + Tarea.Title + " se ha eliminado correctamente", Severity.Success);
        }
        
        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel(); 
}
}